<!DOCTYPE html>
<html lang="en">
<head>
<script>
/* STATIC MODE (no server): force browser/system voice and prevent OpenAI TTS calls */
window.__STATIC_MODE__ = true;
</script>

  <meta charset="UTF-8">
  <title>Cashier English Trainer ‚Äì v9 (NYC voices + your voice)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      background: #1d4ed8;
      color: #111827;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }
    .app {
      width: 100%;
      max-width: 1150px;
      background: #e5e7eb;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      flex-wrap: wrap;
    }
    .title {
      font-size: 1rem;
      font-weight: 700;
    }
    .subtitle {
      font-size: 0.75rem;
      color: #374151;
      max-width: 480px;
    }
    .controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 0.8rem;
    }
    select, button, label.control {
      padding: 4px 6px;
      border-radius: 6px;
      border: none;
      font-size: 0.8rem;
      background: #f9fafb;
    }
    button {
      cursor: pointer;
      background: #2563eb;
      color: #f9fafb;
      font-weight: 600;
    }
    button.secondary {
      background: #6b7280;
      color: #f9fafb;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.3fr);
      gap: 8px;
    }
    @media (max-width: 850px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: #f9fafb;
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 1px 3px rgba(15,23,42,0.12);
    }
    .panel h2 {
      margin: 0 0 4px;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #6b7280;
    }
    .panel .ru-hint {
      font-size: 0.7rem;
      color: #4b5563;
      margin-bottom: 4px;
    }

    /* LEFT COLUMN */
    .left-column {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .customer-panel {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .customer-photo {
      width: 80px;
      height: 80px;
      border-radius: 999px;
      overflow: hidden;
      flex-shrink: 0;
      background: #d1d5db;
    }
    .customer-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .customer-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .bubble {
      background: #eff6ff;
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid #93c5fd;
      font-size: 0.85rem;
      min-height: 34px;
      word-break: break-word;
    }
    .bubble small {
      display: block;
      margin-top: 2px;
      color: #9ca3af;
      font-size: 0.7rem;
    }
    .customer-meta {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .repeat-row {
      margin-top: 4px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-start;
    }
    .repeat-row button {
      padding-inline: 10px;
    }

    .recognized {
      margin-top: 6px;
      padding: 6px;
      border-radius: 6px;
      background: #f3f4f6;
      font-size: 0.8rem;
    }
    .recognized span.label {
      font-size: 0.7rem;
      color: #6b7280;
      display: block;
      margin-bottom: 2px;
    }
    .recognized .text {
      font-weight: 500;
    }
    .score-line {
      margin-top: 4px;
      font-size: 0.75rem;
    }
    .score-line strong.good { color: #15803d; }
    .score-line strong.bad { color: #b91c1c; }

    .bottom-left {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 8px;
    }
    @media (max-width: 700px) {
      .bottom-left {
        grid-template-columns: 1fr;
      }
    }

    .receipt {
      font-size: 0.75rem;
      max-height: 150px;
      overflow-y: auto;
    }
    .receipt-line {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 2px;
    }
    .receipt-total {
      border-top: 1px dashed #9ca3af;
      margin-top: 4px;
      padding-top: 4px;
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      font-size: 0.8rem;
    }
    .feedback {
      margin-top: 4px;
      font-size: 0.75rem;
    }
    .feedback.correct {
      color: #15803d;
    }
    .feedback.wrong {
      color: #b91c1c;
    }

    .keypad {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .calc-display {
      padding: 4px 6px;
      background: #111827;
      color: #f9fafb;
      border-radius: 6px;
      font-size: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .calc-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
    }
    .calc-btn {
      padding: 8px;
      background: #e5e7eb;
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      font-weight: 600;
      user-select: none;
    }
    .calc-btn.action {
      background: #10b981;
      color: #f9fafb;
      border-color: #059669;
      font-size: 0.75rem;
    }
    .calc-btn.clear {
      background: #f97373;
      color: #f9fafb;
      border-color: #ef4444;
      font-size: 0.75rem;
    }
    .calc-btn:active {
      transform: translateY(1px);
    }

    .hint {
      margin-top: 3px;
      font-size: 0.7rem;
      color: #6b7280;
    }

    /* RIGHT COLUMN: products */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 6px;
    }
    .product-card {
      background: #eef2ff;
      border-radius: 8px;
      padding: 4px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.08s ease, border-color 0.08s ease;
      font-size: 0.75rem;
      align-items: center;
      text-align: center;
    }
    .product-card:hover {
      transform: translateY(-1px);
      border-color: #6366f1;
    }
    .product-card.active {
      border-color: #2563eb;
      background: #e0ebff;
    }
    .product-photo {
      width: 70px;
      height: 70px;
      border-radius: 10px;
      background: linear-gradient(135deg, #fef3c7, #fee2e2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }
    .product-name {
      font-weight: 700;
      font-size: 0.8rem;
    }
    .product-price {
      font-size: 0.7rem;
      color: #4b5563;
    }

    /* Footer */
    .footer-panel {
      margin-top: 2px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      font-size: 0.75rem;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #dbeafe;
      color: #1e40af;
      font-size: 0.7rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .mini-btn{
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: #f3f4f6;
      color: #111827;
      font-weight: 800;
      line-height: 1;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .mini-btn:active{ transform: translateY(1px); }
    .mini-btn.danger{
      background:#fee2e2;
      border-color:#fecaca;
      color:#991b1b;
    }

    audio#streetAudio {
      display: none;
    }

    /* === –°–¢–ò–õ–ò –î–õ–Ø –ó–ê–ú–ö–ê === */
    #gatekeeper-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f0f2f5;
      z-index: 99999999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: sans-serif;
    }
    .gatekeeper-card {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    .gatekeeper-input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      text-align: center;
      box-sizing: border-box;
    }
    .gatekeeper-button {
      width: 100%;
      padding: 12px;
      background: #000;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
    }
    .gatekeeper-link {
      display: block;
      width: 100%;
      padding: 12px;
      background: #fff;
      color: #007AFF;
      border: none;
      text-decoration: underline;
      font-weight: bold;
      box-sizing: border-box;
      margin-top: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="gatekeeper-overlay">
    <div class="gatekeeper-card">
        <h2 style="margin-top:0; color: #333;">üîí –î–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç</h2>
        <p style="color:#666; margin-bottom:20px; font-size: 14px;">
            –í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è Cashier English Trainer.
        </p>
        
        <input type="text" id="access-code" placeholder="EFI-..." class="gatekeeper-input">
        
        <a href="https://payhip.com/b/EJdPx" target="_blank" class="gatekeeper-link">
            Get the password
        </a>

        <div style="height: 15px;"></div>

        <button onclick="checkAccess()" class="gatekeeper-button">–í–æ–π—Ç–∏</button>
    </div>
</div>

<div class="app">
  <div class="top-bar">
    <div>
      <div class="title">Cashier Trainer ‚Äì English (NYC corner store) ‚Äì v9</div>
      <div class="subtitle">
        –ï—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-–ª–∏–±–æ –ø—Ä–∏—á–∏–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–º –¥–ª—è –≤—Ö–æ–¥–∞.
      </div>
    </div>
    <div class="controls">
      <label class="control">
        Level:
        <select id="levelSelect">
          <option value="A1">A1 ‚Äì Easy (1 item)</option>
          <option value="A2">A2 ‚Äì Medium (1‚Äì2 items)</option>
          <option value="B1">B1 ‚Äì Hard (2‚Äì3 items, corrections)</option>
        </select>
      </label>
<label class="control">
        Speed:
        <select id="speedSelect">
          <option value="0.85">Slow</option>
          <option value="1.0" selected>Normal</option>
          <option value="1.15">Fast</option>
        </select>
      </label>
      <label class="control">
        <input type="checkbox" id="showTranscript" checked> Show text
      </label>
    </div>
  </div>

  <div class="layout">
    <div class="left-column">
      <div class="panel">
        <h2>Customer</h2>
        <div class="ru-hint">
          –ù–∞–∂–∏–º–∞–π <b>Next customer</b> ‚Üí —Å–ª—É—à–∞–π –∑–∞–∫–∞–∑ ‚Üí
          <b>Repeat voice</b> –∏–ª–∏ <b>Record my voice</b> ‚Üí
          –∑–∞–∫–∞–∑ –ø–æ–ø–∞–¥—ë—Ç –≤ —á–µ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏.
        </div>
        <div class="customer-panel">
          <div class="customer-photo"><img id="customerImg" src="" alt="Customer"></div>
          <div class="customer-info">
            <div class="bubble" id="bubble">
              Press ‚ÄúNext customer‚Äù to start.
              <small>First, use your ears. Then open the text if needed.</small>
            </div>
            <div class="customer-meta" id="customerMeta">Waiting for first customer.</div>
          </div>
        </div>
        <div class="repeat-row">
          <button id="repeatBtn" class="secondary">Repeat voice</button>
          <button id="recordBtn" class="secondary">Record my voice</button>
          <button id="stopBtn" class="secondary">Stop</button>
          <span id="recStatus" class="hint" style="display:none;color:#b91c1c;font-weight:600;">Listening‚Ä¶</span>
        </div>
        <div class="recognized" id="recognizedBox" style="display:none;">
          <span class="label">Recognition result:</span>
          <div class="text" id="recognizedText">‚Äî</div>
          <div class="score-line" id="scoreLine"></div>
        </div>
      </div>

      <div class="bottom-left">
        <div class="panel">
          <h2>Receipt</h2>
          <div class="receipt" id="receipt"></div>
          <div class="receipt-total" id="receiptTotal">
            <span>Total</span>
            <span>$0.00</span>
          </div>
          <button id="submitBtn" style="width:100%;margin-top:4px;font-size:0.8rem;">Submit order</button>
          <button id="nextBtn" style="width:100%;margin-top:4px;font-size:0.8rem;">Next customer</button>
          <div class="feedback" id="feedback"></div>
<div id="undoBar" style="display:none;margin-top:6px;padding:6px;border-radius:8px;background:#fffbeb;border:1px solid #f59e0b;font-size:0.75rem;display:flex;align-items:center;justify-content:space-between;gap:8px;"><span id="undoText">Added item.</span><button id="undoBtn" class="secondary" style="padding:4px 10px;">Undo</button></div>
        </div>

        <div class="panel keypad">
          <h2>Keypad</h2>
          <div class="calc-display">
            <span id="pendingInfo">Product: ‚Äî</span>
            <strong id="currentQty">Qty: 1</strong>
          </div>
          <div class="calc-grid">
            <div class="calc-btn">1</div>
            <div class="calc-btn">2</div>
            <div class="calc-btn">3</div>
            <div class="calc-btn">4</div>
            <div class="calc-btn">5</div>
            <div class="calc-btn">6</div>
            <div class="calc-btn">7</div>
            <div class="calc-btn">8</div>
            <div class="calc-btn">9</div>
            <div class="calc-btn clear">C</div>
            <div class="calc-btn">0</div>
            <div class="calc-btn action">OK</div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Products</h2>
      <div class="products-grid" id="productsGrid"></div>
      <div class="hint">NYC corner store items with realistic prices.</div>
    </div>
  </div>

  <div class="footer-panel panel">
    <div>
      <div class="badge">Listening strategy</div>
      <ul style="margin:4px 0 0 16px;padding:0;font-size:0.72rem;">
        <li>–ù–∞—á–Ω–∏ —Å <b>A1</b>: –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä, –ø—Ä–æ—Å—Ç—ã–µ —Ñ—Ä–∞–∑—ã.</li>
        <li>–°–Ω–∞—á–∞–ª–∞ —Å–ª—É—à–∞–π 2‚Äì3 —Ä–∞–∑–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞, —Ç–æ–ª—å–∫–æ —É—à–∏.</li>
        <li>–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è —Å–Ω–∞—á–∞–ª–∞ –Ω–∞ —á–∏—Å–ª–µ (three / two / four), –ø–æ—Ç–æ–º –Ω–∞ —Ç–æ–≤–∞—Ä–µ.</li>
        <li>–ï—Å–ª–∏ —Å–æ–≤—Å–µ–º –ø–æ—Ç–µ—Ä—è–ª—Å—è ‚Äì –≤–∫–ª—é—á–∏ <b>Show text</b> –∫–∞–∫ –ø–æ–¥—Å–∫–∞–∑–∫—É.</li>
      </ul>
    </div>
  </div>
</div>

<audio id="streetAudio" src="street_ambience.wav" loop></audio>

<script>
// === –õ–û–ì–ò–ö–ê –ó–ê–ú–ö–ê ===
const SECRET_CODE = "EFI-2026-Al!KZ6?592<";
const overlay = document.getElementById('gatekeeper-overlay');
const accessInput = document.getElementById('access-code');

if (localStorage.getItem('is_paid_cashier_v2') === 'true') {
    overlay.style.display = 'none';
}

function checkAccess() {
    let code = accessInput.value.trim();
    code = code.replace(/‚Äî/g, '-').replace(/‚Äì/g, '-');
    const map = {'–ê':'A', '–í':'B', '–ï':'E', '–ö':'K', '–ú':'M', '–ù':'H', '–û':'O', '–†':'P', '–°':'C', '–¢':'T', '–•':'X'};
    code = code.replace(/[–ê–í–ï–ö–ú–ù–û–†–°–¢–•]/g, (m) => map[m]);

    if (code === SECRET_CODE) {
        localStorage.setItem('is_paid_cashier_v2', 'true');
        overlay.style.display = 'none';
        alert("–î–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç!");
    } else {
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥!");
        accessInput.value = '';
    }
}

// ---- LOCAL CUSTOMER PHOTOS ----
const customers = [
  { id: "m1", img: "customers/male_1.jpg",   gender: "male",   style: "calm",  label: "Calm guy" },
  { id: "m2", img: "customers/male_2.jpg",   gender: "male",   style: "fast",  label: "Fast-talking guy" },
  { id: "m3", img: "customers/male_3.jpg",   gender: "male",   style: "calm",  label: "Polite man" },
  { id: "f1", img: "customers/female_1.jpg", gender: "female", style: "fast",  label: "Busy woman" },
  { id: "f2", img: "customers/female_2.jpg", gender: "female", style: "calm",  label: "Friendly woman" },
  { id: "f3", img: "customers/female_3.jpg", gender: "female", style: "calm",  label: "Chill girl" }
];

// ---- PRODUCTS ----
const products = [
  { id: 'apple',      name: 'Apple',      price: 1.20, unit: 'each',   icon: 'üçé' },
  { id: 'milk',       name: 'Milk',       price: 2.50, unit: 'bottle', icon: 'ü•õ' },
  { id: 'bread',      name: 'Bread',      price: 2.50, unit: 'loaf',   icon: 'üçû' },
  { id: 'sugar',      name: 'Sugar',      price: 2.00, unit: 'bag',    icon: 'üßÇ' },
  { id: 'bananas',    name: 'Bananas',    price: 0.60, unit: 'each',   icon: 'üçå' },
  { id: 'cigarettes', name: 'Cigarettes', price: 14.00,unit: 'pack',   icon: 'üö¨' },
  { id: 'water',      name: 'Water',      price: 1.50, unit: 'bottle', icon: 'üíß' },
  { id: 'soda',       name: 'Soda',       price: 2.00, unit: 'can',    icon: 'ü•§' },
  { id: 'chips',      name: 'Chips',      price: 3.00, unit: 'bag',    icon: 'üçü' },
  { id: 'beer',       name: 'Beer',       price: 5.50, unit: 'bottle', icon: 'üç∫' },
  { id: 'rice',       name: 'Rice',       price: 4.50, unit: 'bag',    icon: 'üçö' }
];

const orders = {
  A1: [
    { text: "Hey, can I grab three apples, please?", items: [{id:'apple', qty:3}] },
    { text: "Good morning, let me get two bottles of milk.", items: [{id:'milk', qty:2}] },
    { text: "Hi, just one loaf of bread, thanks.", items: [{id:'bread', qty:1}] },
    { text: "Yo, can I get four bananas?", items: [{id:'bananas', qty:4}] },
    { text: "Can I get one pack of cigarettes, please?", items: [{id:'cigarettes', qty:1}] },
    { text: "I'll take three bottles of water.", items: [{id:'water', qty:3}] },
    { text: "Could you give me one bag of sugar?", items: [{id:'sugar', qty:1}] },
    { text: "Hi, can I get five apples?", items: [{id:'apple', qty:5}] },
    { text: "I'd like two cans of soda, please.", items: [{id:'soda', qty:2}] },
    { text: "Can I have one bag of rice?", items: [{id:'rice', qty:1}] }
  ],
  A2: [
    { text: "Hey, can I grab two apples and one bottle of milk?", items: [{id:'apple', qty:2},{id:'milk',qty:1}] },
    { text: "Hi, I‚Äôd like three bananas and one loaf of bread.", items: [{id:'bananas',qty:3},{id:'bread',qty:1}] },
    { text: "Can I have two cans of soda and one bag of chips?", items: [{id:'soda',qty:2},{id:'chips',qty:1}] },
    { text: "I'll take one bottle of water and one loaf of bread.", items: [{id:'water',qty:1},{id:'bread',qty:1}] },
    { text: "Can you give me one bag of rice and one bag of sugar?", items: [{id:'rice',qty:1},{id:'sugar',qty:1}] },
    { text: "Hi, two bottles of beer and one bag of chips, please.", items: [{id:'beer',qty:2},{id:'chips',qty:1}] },
    { text: "I'd like one bottle of milk and one loaf of bread.", items: [{id:'milk',qty:1},{id:'bread',qty:1}] },
    { text: "Can I get two apples and two bananas?", items: [{id:'apple',qty:2},{id:'bananas',qty:2}] },
    { text: "Just one can of soda and one bag of chips, thanks.", items: [{id:'soda',qty:1},{id:'chips',qty:1}] },
    { text: "I'll take one bottle of beer and one bottle of water.", items: [{id:'beer',qty:1},{id:'water',qty:1}] }
  ],
  B1: [
    { text: "Hey, can I get one apple, one banana, and actually skip the orange?", items:[{id:'apple',qty:1},{id:'bananas',qty:1}] },
    { text: "Let me have two bottles of water, one soda, and a bag of chips‚Äîactually, no soda.", items:[{id:'water',qty:2},{id:'chips',qty:1}] },
    { text: "I'll grab one loaf of bread, some butter, and a bag of sugar‚Äîactually, forget the butter.", items:[{id:'bread',qty:1},{id:'sugar',qty:1}] },
    { text: "Three bananas, two apples, and one bag of rice‚Äîactually, just the rice is fine.", items:[{id:'rice',qty:1}] },
    { text: "Hi, can I get one bottle of milk, one can of soda, and a bag of chips?", items:[{id:'milk',qty:1},{id:'soda',qty:1},{id:'chips',qty:1}] },
    { text: "I'll take two beers, one bottle of water, and a bag of chips, please.", items:[{id:'beer',qty:2},{id:'water',qty:1},{id:'chips',qty:1}] },
    { text: "Can I get one bag of rice, one loaf of bread, and two bottles of water?", items:[{id:'rice',qty:1},{id:'bread',qty:1},{id:'water',qty:2}] },
    { text: "I'd like one bottle of milk, two cans of soda, and one beer.", items:[{id:'milk',qty:1},{id:'soda',qty:2},{id:'beer',qty:1}] },
    { text: "Could I have two apples, three bananas, and one bottle of water?", items:[{id:'apple',qty:2},{id:'bananas',qty:3},{id:'water',qty:1}] },
    { text: "One loaf of bread, one bag of sugar, and one bottle of milk, thanks.", items:[{id:'bread',qty:1},{id:'sugar',qty:1},{id:'milk',qty:1}] }
  ]
};

const thanksPhrases = [
  "Thanks a lot, have a good one.",
  "Thank you, have a nice day.",
  "Appreciate it, thanks.",
  "Thanks, you‚Äôre all set.",
  "Thank you so much.",
  "Awesome, thanks.",
  "Thanks, that‚Äôs perfect.",
  "Thanks, see you next time.",
  "Cool, thank you.",
  "Thanks, take care."
];

// ---- STATE ----
let basket = [];
let currentOrder = null;
let currentCustomer = null;
let pendingProductId = null;
let qtyBuffer = "";
let qtyValue = 1;
let lastOrderText = "";
let bgAudioStarted = false;
let recognition = null;
let isRecording = false;
let lastAction = null; 
let undoTimer = null;

const productsGrid = document.getElementById("productsGrid");
const receiptEl = document.getElementById("receipt");
const receiptTotalEl = document.getElementById("receiptTotal").lastElementChild;
const feedbackEl = document.getElementById("feedback");
const bubbleEl = document.getElementById("bubble");
const customerMetaEl = document.getElementById("customerMeta");
const levelSelect = document.getElementById("levelSelect");
const nextBtn = document.getElementById("nextBtn");
const repeatBtn = document.getElementById("repeatBtn");
const submitBtn = document.getElementById("submitBtn");
const currentQtyEl = document.getElementById("currentQty");
const pendingInfoEl = document.getElementById("pendingInfo");
const customerImgEl = document.getElementById("customerImg");
const speedSelect = document.getElementById("speedSelect");
const showTranscriptCheckbox = document.getElementById("showTranscript");
const recordBtn = document.getElementById("recordBtn");
const stopBtn = document.getElementById("stopBtn");
const recStatusEl = document.getElementById("recStatus");
const recognizedBox = document.getElementById("recognizedBox");
const recognizedTextEl = document.getElementById("recognizedText");
const scoreLineEl = document.getElementById("scoreLine");

function cloneBasket(b){ return b.map(x => ({id:x.id, qty:x.qty})); }

function showUndo(message){
  const bar = document.getElementById("undoBar");
  const txt = document.getElementById("undoText");
  if (!bar || !txt) return;
  txt.textContent = message;
  bar.style.display = "flex";
  clearTimeout(undoTimer);
  undoTimer = setTimeout(() => { bar.style.display = "none"; }, 4500);
}

function hideUndo(){
  const bar = document.getElementById("undoBar");
  if (bar) bar.style.display = "none";
}

function setLastAction(snapshot, message){
  lastAction = { snapshot };
  showUndo(message);
}

function undoLast(){
  if (!lastAction) return;
  basket = cloneBasket(lastAction.snapshot);
  renderBasket();
  updatePendingDisplay();
  hideUndo();
  lastAction = null;
}

function tokenize(str) {
  return str.toLowerCase()
    .replace(/[^a-z0-9\s]/g, " ")
    .split(/\s+/)
    .filter(Boolean);
}

const stopWords = new Set(["hey","hi","yo","can","i","get","let","me","just","please","thanks","thank","you",
  "actually","and","the","a","to","of","one","two","three","four","five","six","seven","eight","nine","ten",
  "morning","good","lot","so","much","bag","bottle","bottles","pack","loaf","some","grab","have","take","like"]);

const numberWords = {
  "zero":0,"one":1,"two":2,"three":3,"four":4,"five":5,"six":6,"seven":7,"eight":8,"nine":9,"ten":10,
  "eleven":11,"twelve":12,"thirteen":13,"fourteen":14,"fifteen":15,"sixteen":16,"seventeen":17,"eighteen":18,"nineteen":19,
  "twenty":20
};

function parseNumberToken(tok){
  tok = tok.toLowerCase();
  if (tok in numberWords) return numberWords[tok];
  if (/^\d+$/.test(tok)) return parseInt(tok,10);
  if (tok === "a" || tok === "an") return 1;
  return null;
}

const productKeywords = {
  "apple":      ["apple","apples"],
  "bananas":    ["banana","bananas"],
  "milk":       ["milk"],
  "bread":      ["bread","loaf","loaves"],
  "sugar":      ["sugar"],
  "water":      ["water","water bottle"],
  "soda":       ["soda","sodas","pop"],
  "chips":      ["chips","chip"],
  "beer":       ["beer","beers"],
  "cigarettes": ["cigarette","cigarettes","cigs"]
};

const productPhrases = {
  "bread": ["loaf of bread", "a loaf of bread", "bread"],
  "water": ["bottle of water", "a bottle of water", "water bottle", "water"],
  "milk":  ["a gallon of milk", "gallon of milk", "milk"],
  "cigarettes": ["pack of cigarettes", "a pack of cigarettes", "cigs", "cigarettes"]
};

function extractSpokenOrder(text){
  const raw = (text || "").toLowerCase();
  const toks = tokenize(text);
  const result = {};
  function mark(pid, qty){
    if (!result[pid]) result[pid] = { qty: null, mentioned: true };
    if (typeof qty === "number") result[pid].qty = qty;
  }
  for (const [pid, phrases] of Object.entries(productPhrases)){
    for (const ph of phrases){
      if (raw.includes(ph)){ mark(pid, null); break; }
    }
  }
  for (let i=0;i<toks.length;i++){
    for (const [pid, keys] of Object.entries(productKeywords)){
      if (!keys.includes(toks[i])) continue;
      let qty = null;
      for (let back=1; back<=4; back++){
        const j = i-back;
        if (j < 0) break;
        const n = parseNumberToken(toks[j]);
        if (n !== null){ qty = n; break; }
      }
      mark(pid, qty);
    }
  }
  return result;
}

function expectedOrderMap(order){
  const m = {};
  (order.items || []).forEach(it => { m[it.id] = (m[it.id] || 0) + it.qty; });
  return m;
}

function filterImportant(tokens) {
  return tokens.filter(t => !stopWords.has(t));
}

function calcSimilarity(reference, spoken) {
  const refTokens = filterImportant(tokenize(reference));
  const spokenTokens = filterImportant(tokenize(spoken));
  if (!refTokens.length) return 0;
  const spokenSet = new Set(spokenTokens);
  let common = 0;
  refTokens.forEach(t => { if (spokenSet.has(t)) common++; });
  return common / refTokens.length;
}

function initRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    feedbackEl.textContent = "SpeechRecognition not supported.";
    return;
  }
  recognition = new SR();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = () => { isRecording = true; recStatusEl.style.display = "inline"; };
  recognition.onerror = () => { isRecording = false; recStatusEl.style.display = "none"; };
  recognition.onend = () => { isRecording = false; recStatusEl.style.display = "none"; };
  recognition.onresult = (e) => {
    const text = e.results[0][0].transcript;
    recognizedBox.style.display = "block";
    recognizedTextEl.textContent = text;
    if (!currentOrder || !lastOrderText) return;
    const score = calcSimilarity(lastOrderText, text);
    const spokenMap = extractSpokenOrder(text);
    const expectedMap = expectedOrderMap(currentOrder);
    const expectedKeys = Object.keys(expectedMap);
    const productsMatch = expectedKeys.every(k => spokenMap[k]?.mentioned);
    const noExtraProducts = Object.keys(spokenMap).every(k => expectedMap[k] !== undefined);
    const qtyOk = productsMatch && expectedKeys.every(k => {
      const heard = spokenMap[k]?.qty;
      if (heard === null || heard === undefined) return true;
      return heard === expectedMap[k];
    });

    if (score >= 0.45 && productsMatch && noExtraProducts && qtyOk){
      scoreLineEl.innerHTML = 'Score: <strong class="good">OK</strong> ‚Äì Order added.';
      basket = currentOrder.items.map(it => ({ id: it.id, qty: it.qty }));
      renderBasket();
      const phrase = randomThanks();
      lastOrderText = phrase;
      updateBubbleText();
      speak(phrase, currentCustomer);
    } else {
      scoreLineEl.innerHTML = '<strong class="bad">Try again</strong>';
    }
  };
}

function startRecording() { if (recognition && !isRecording) try { recognition.start(); } catch(e) {} }
function stopRecordingFunc() { if (recognition && isRecording) recognition.stop(); }

function renderProducts(){
  productsGrid.innerHTML = "";
  products.forEach(p => {
    const div = document.createElement("div");
    div.className = "product-card";
    div.dataset.id = p.id;
    div.innerHTML = `<div class="product-photo">${p.icon}</div><div class="product-name">${p.name}</div><div class="product-price">$${p.price.toFixed(2)}</div>`;
    div.addEventListener("click", () => selectProduct(p.id));
    productsGrid.appendChild(div);
  });
}

function updatePendingDisplay(){
  const product = pendingProductId ? products.find(p => p.id === pendingProductId) : null;
  pendingInfoEl.textContent = "Product: " + (product ? product.name : "‚Äî");
  currentQtyEl.textContent = "Qty: " + (qtyValue || 1);
  document.querySelectorAll(".product-card").forEach(card => card.classList.toggle("active", card.dataset.id === pendingProductId));
}

function selectProduct(id){ pendingProductId = id; updatePendingDisplay(); }

function addPendingToBasket(){
  if (!pendingProductId) return;
  const before = cloneBasket(basket);
  const qty = qtyValue > 0 ? qtyValue : 1;
  const existing = basket.find(i => i.id === pendingProductId);
  if (existing) existing.qty += qty; else basket.push({id: pendingProductId, qty});
  qtyBuffer = ""; qtyValue = 1;
  renderBasket(); updatePendingDisplay();
  setLastAction(before, `Added items. Undo?`);
}

function renderBasket(){
  receiptEl.innerHTML = "";
  let total = 0;
  if (!basket.length) receiptEl.innerHTML = '<div style="color:#6b7280; font-size:0.75rem;">Cart is empty.</div>';
  basket.forEach(item => {
    const product = products.find(p => p.id === item.id);
    if (!product) return;
    total += product.price * item.qty;
    const line = document.createElement("div");
    line.className = "receipt-line";
    line.innerHTML = `<span>${item.qty} x ${product.name}</span> <button class="mini-btn danger" data-act="remove" data-id="${product.id}">‚úï</button>`;
    receiptEl.appendChild(line);
  });
  receiptTotalEl.textContent = "$" + total.toFixed(2);
}

function speak(text, opts){
  if (!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "en-US";
  utter.rate = parseFloat(speedSelect.value) || 1.0;
  window.speechSynthesis.speak(utter);
}

function startBackgroundNoise(){
  if (bgAudioStarted) return;
  bgAudioStarted = true;
  const audioEl = document.getElementById("streetAudio");
  if (audioEl){ audioEl.volume = 0.08; audioEl.play().catch(() => {}); }
}

function newOrder(){
  const list = orders[levelSelect.value];
  currentOrder = list[Math.floor(Math.random() * list.length)];
  basket = []; qtyBuffer = ""; qtyValue = 1; pendingProductId = null;
  renderBasket();
  currentCustomer = customers[Math.floor(Math.random() * customers.length)];
  customerImgEl.src = currentCustomer.img;
  lastOrderText = currentOrder.text;
  updateBubbleText();
  customerMetaEl.textContent = "NYC Store ‚Ä¢ " + currentCustomer.label;
  updatePendingDisplay();
  startBackgroundNoise();
  speak(currentOrder.text, currentCustomer);
}

function repeatOrder(){ if (lastOrderText) speak(lastOrderText, currentCustomer); }
function randomThanks(){ return thanksPhrases[Math.floor(Math.random() * thanksPhrases.length)]; }

function submitOrder(){
  if (!currentOrder) return;
  const correct = JSON.stringify(currentOrder.items.sort((a,b)=>a.id.localeCompare(b.id))) === JSON.stringify(basket.sort((a,b)=>a.id.localeCompare(b.id)));
  if (correct){
    feedbackEl.textContent = "Correct!";
    feedbackEl.className = "feedback correct";
    const phrase = randomThanks();
    lastOrderText = phrase; updateBubbleText();
    speak(phrase, currentCustomer);
  } else {
    feedbackEl.textContent = "Incorrect.";
    feedbackEl.className = "feedback wrong";
  }
}

function setupKeypad(){
  document.querySelectorAll(".calc-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const val = btn.textContent.trim();
      if (btn.classList.contains("clear")){ qtyBuffer = ""; qtyValue = 1; pendingProductId = null; }
      else if (btn.classList.contains("action")){ addPendingToBasket(); }
      else if (/^[0-9]$/.test(val)){ if (qtyBuffer.length < 3){ qtyBuffer += val; qtyValue = parseInt(qtyBuffer, 10); } }
      updatePendingDisplay();
    });
  });
}

function updateBubbleText(){
  if (!lastOrderText) return;
  bubbleEl.innerHTML = showTranscriptCheckbox.checked ? lastOrderText : 'Transcript hidden.';
}

renderProducts();
updatePendingDisplay();
setupKeypad();
initRecognition();
currentCustomer = customers[0];
customerImgEl.src = currentCustomer.img;

receiptEl.addEventListener("click", (e) => {
  const btn = e.target.closest(".mini-btn");
  if (btn && btn.dataset.act === "remove"){
    const before = cloneBasket(basket);
    basket = basket.filter(x => x.id !== btn.dataset.id);
    renderBasket();
    setLastAction(before, "Removed item.");
  }
});

document.getElementById("undoBtn").addEventListener("click", undoLast);
nextBtn.addEventListener("click", newOrder);
repeatBtn.addEventListener("click", repeatOrder);
submitBtn.addEventListener("click", submitOrder);
showTranscriptCheckbox.addEventListener("change", updateBubbleText);
recordBtn.addEventListener("click", startRecording);
stopBtn.addEventListener("click", stopRecordingFunc);
</script>
</body>
</html>
